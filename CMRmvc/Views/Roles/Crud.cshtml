@model CMRmvc.ViewModel.RoleViewModel;

@{
    ViewData["Title"] = "Crud";
    Layout = "~/Views/Shared/AdminLTE/_Layout.cshtml";

    string title = "Roles";
    string ico = "fas fa-align-justify";
    if (ViewBag.Action == "Edit") { title = "Modificar Roles"; ico = "far fa-edit"; }
    else if (ViewBag.Action == "Create") { title = "Alta Roles"; ico = "fas fa-plus-circle"; }
    else if (ViewBag.Action == "Details") { title = "Detalles Roles"; ico = "fas fa-info-circle"; }
}

<br />
<br />

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- left column -->
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="@ico"></i> @title
                        </h4>
                    </div>
                    <!-- /.card-header -->
                    <!-- form start -->
                    <form class="form-horizontal" method="post" asp-action="@ViewBag.Action">
                        <div class="card-body">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                            <div class="form-group row">
                                <input type="hidden" asp-for="Id" />
                                <input type="hidden" asp-for="ConcurrencyStamp" />

                                @for (int pmh = 0; pmh < Model.PerfilMenuHijo.Count; pmh++)
                                {
                                    <input type="hidden" asp-for="PerfilMenuHijo[pmh].IdMenuHijo" />
                                    <input type="hidden" asp-for="PerfilMenuHijo[pmh].IdRol" />
                                    <input type="hidden" asp-for="PerfilMenuHijo[pmh].IdPerfilMenuHijo" />
                                }

                                @for (int ra = 0; ra < Model.RolesAcciones.Count; ra++)
                                {
                                    <input type="hidden" asp-for="RolesAcciones[ra].IdMenuHijoAccion" />
                                    <input type="hidden" asp-for="RolesAcciones[ra].IdRol" />
                                    <input type="hidden" asp-for="RolesAcciones[ra].IdPerfilAccion" />
                                }

                                <label asp-for="Name" class="col-sm-2 col-form-label"></label>
                                <div class="col-sm-10">
                                    <input asp-for="Name" class="form-control" readonly="@ViewBag.IsReadOnly">
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
 
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label" asp-for="IsActive"></label>
                                <div class="col-sm-10">
                                    @if (ViewBag.IsReadOnly != null && ViewBag.IsReadOnly)
                                    {
                                        <input type="checkbox" asp-for="IsActive" id="myswitch" class="checkbox_switch" data-on-text="SI" data-off-text="NO" checked data-bootstrap-switch data-off-color="danger" data-on-color="success" disabled>
                                    }
                                    else
                                    {
                                        <input type="checkbox" asp-for="IsActive" id="myswitch" class="checkbox_switch" data-on-text="SI" data-off-text="NO" checked data-bootstrap-switch data-off-color="danger" data-on-color="success">
                                    }
                                </div>
                            </div>

                            <!-- #region CHECKS ROLES -->
                            @if (Model != null && Model.Menu != null && Model.Menu.Count > 0)
                            {
                                <div class="row m-3" id="rowGroupChecks">
                                    @for (int i = 0; i < Model.Menu.Count; i++)
                                    {
                                    <div class="col-md-4 border m-2" style="min-width:420px !important;">
                                        <div class="row" style="background-color:#0050cb; color:azure; padding-bottom:6px;padding-right:6px; padding-left:6px;padding-top:-8px;">
                                            <div class="col-md-7 mt-3">
                                                @{
                                                    string dataClassPadre = "padre " + i;
                                                    string idPadre = "padre_" + Model.Menu[i].IdMenuPadre;
                                                }
                                                <input type="hidden" asp-for="Menu[i].IdMenuPadre" />
                                                <input type="hidden" asp-for="Menu[i].Icono" />
                                                <input type="hidden" asp-for="Menu[i].Nombre" />
                                                <span><input type="checkbox" data-readonly="@ViewBag.IsReadOnly" asp-for="Menu[i].IsChecked" style="width:18px; height:17px;" id="@idPadre" data-forid="@i" data-id="@Model.Menu[i].IdMenuPadre" class="@dataClassPadre" >&nbsp;&nbsp;&nbsp;</span>
                                                <span style="font-weight:bold;"><i class="@Model.Menu[i].Icono" style="font-size:large;">&nbsp;&nbsp;&nbsp;</i><span style="font-size:large;max-width:140px !important">@Model.Menu[i].Nombre</span></span>
                                            </div>
                                            <div class="col-md-5 mt-3">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <i title="Alta" class="fa fa-plus"></i>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <i title="Editar" class="fa fa-edit"></i>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <i title="Eliminar" class="fa fa-trash"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        @for (int fila = 0; fila < Model.Menu[i].MenuItemHijo.Count; fila++)
                                        {

                                            <div class="row mt-2" style="padding-bottom:6px;padding-right:6px; padding-left:6px;padding-top:-8px;">
                                                <div class="col-md-7">
                                                    @{
                                                        string dataClassHijo = i + " hijo " + fila;
                                                        string idFila = "fila_" + Model.Menu[i].MenuItemHijo[fila].IdMenuHijo + "_" + i;
                                                    }
                                                    <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].IdMenuHijo" />
                                                    <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].IdMenuPadre" />
                                                    <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].Icono" />
                                                    <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].Nombr" />
                                                    <span>
                                                        <input type="checkbox" data-readonly="@ViewBag.IsReadOnly" style="width:16px; height:16px;" asp-for="Menu[i].MenuItemHijo[fila].IsChecked" id="@idFila" data-fila="@fila" data-forid="@i" data-id="@Model.Menu[i].MenuItemHijo[fila].IdMenuHijo" data-idpadre="@Model.Menu[i].IdMenuPadre" class="@dataClassHijo" />
                                                    </span>&nbsp;&nbsp;&nbsp;
                                                    <span style="width:auto;font-size:small; text-align:left !important">@Model.Menu[i].MenuItemHijo[fila].Nombr</span>
                                                </div>
                                                <div class="col-md-5 ">
                                                    <div class="row">
                                                        @for (int u = 0; u < Model.Menu[i].MenuItemHijo[fila].MenuHijoAcciones.Count; u++)
                                                        {
                                                            <div class="col-sm-3">
                                                                @{
                                                                    Model.Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IsChecked = Model.RolesAcciones.Where(x => x.IdMenuHijoAccion == Model.Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IdMenuHijoAccion).Any(y => y.IdRol == Model.Id) ? true : false;
                                                                    string dataClassAccion = i + " accion " + fila;
                                                                    string idAccion = "accion_" + Model.Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IdMenuHijoAccion + "_" + fila + "_" + i;
                                                                }
                                                                <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IdMenuHijoAccion" />
                                                                <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IdMenuHijo" />
                                                                <input type="hidden" asp-for="Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].RolesAcciones" />
                                                                <input type="checkbox" data-readonly="@ViewBag.IsReadOnly" asp-for="Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IsChecked" data-foraccionid="@u" data-fila="@fila" id="@idAccion" data-forid="@i" data-idpadre="@Model.Menu[i].IdMenuPadre" data-idhijo="@Model.Menu[i].MenuItemHijo[fila].IdMenuHijo" class="@dataClassAccion" data-id="@Model.Menu[i].MenuItemHijo[fila].MenuHijoAcciones[u].IdMenuHijoAccion" style="width:19px; height:16px;">
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <h5 class="mt-3 text-danger">No existen ROLES para asignar.</h5>
                            }
                        </div>
                        <div class="card-footer">
                            <button type="submit" asp-action="Index" class="btn btn-default">Volver</button>
                            @if (!ViewBag.IsReadOnly)
                            {
                                <button type="submit" value="Guardar" class="btn btn-primary float-right">Guardar</button>
                            }
                        </div>
                    </form>
                </div>
                <!-- /.card -->
            </div>
        </div>

    </div>
</section>


<!-- #region Clicks check -->

<script type="text/javascript">

    function ComprobarHijoSelect(findPadre, forID) {
        const elementsFila = $(document).find(findPadre);
        var count = 0;
        for (var x = 0; x < elementsFila.length; x++) {

            const nameID = elementsFila[x].getAttribute("id");

            if (nameID.includes('fila')) {
                if (!$(document).find("#" + nameID).prop('checked')) count++;
            }

        }

        if (count == 0) $(document).find("#padre_" + forID).prop('checked', true);
        else $(document).find("#padre_" + forID).prop('checked', false);

    }


    function ComprobarAccionesSelect(findPadre, findFila, idHijo, idFor, idPadre) {

        const hijosFila = $(document).find(findPadre + findFila);
        var count = 0;

        for (var x = 0; x < hijosFila.length; x++) {

            const nameID = hijosFila[x].getAttribute("id");

            if (nameID.includes('accion')) {
                if (!$(document).find("#" + nameID).prop('checked')) count++;
            }

        }

        if (count == 0) $(document).find("#fila_" + idHijo + "_" + idFor).prop('checked', true);
        else $(document).find("#fila_" + idHijo + "_" + idFor).prop('checked', false);

        ComprobarHijoSelect(findPadre, idPadre);
    }

    $(document).ready(function () {

        $(".padre").click(function () {
 
            const isreadOnly = $(this).attr("data-readonly");
            if (isreadOnly.toLowerCase() == 'false') {
                var forID = $(this).attr("data-forid");
                const myfind = "[data-forid=" + forID + "]";
                $(document).find(myfind).prop('checked', this.checked);
            } else {
                if (this.checked) $(document).find("#"+ $(this).attr("id")).prop('checked', false);
                else $(document).find("#" + $(this).attr("id")).prop('checked', true);
            }

        });

        $(".hijo").click(function () {

            const isreadOnly = $(this).attr("data-readonly");

            if (isreadOnly.toLowerCase() == 'false') {

                var forID = $(this).attr("data-forid");
                var myfila = $(this).attr("data-fila");
                var idPadre = $(this).attr("data-idpadre");
                const myfindfila = "[data-fila=" + myfila + "]";
                const myfindpadre = "[data-forid=" + forID + "]";

                $(document).find(myfindfila + myfindpadre).prop('checked', this.checked);

                ComprobarHijoSelect(myfindpadre, idPadre);

            } else {
                if (this.checked) $(document).find("#" + $(this).attr("id")).prop('checked', false);
                else $(document).find("#" + $(this).attr("id")).prop('checked', true);
            }

        });

        $(".accion").click(function () {

            const isreadOnly = $(this).attr("data-readonly");

            if (isreadOnly.toLowerCase() == 'false') {

                var forID = $(this).attr("data-forid");
                var fila = $(this).attr("data-fila");
                var idPadre = $(this).attr("data-idpadre");
                var idHijo = $(this).attr("data-idhijo");

                const myfindfila = "[data-fila=" + fila + "]";
                const myfindpadre = "[data-forid=" + forID + "]";

                ComprobarAccionesSelect(myfindpadre, myfindfila, idHijo, forID, idPadre);

            } else {
                if (this.checked) $(document).find("#" + $(this).attr("id")).prop('checked', false);
                else $(document).find("#" + $(this).attr("id")).prop('checked', true);
            }

        });


    });



</script>
<script>
    $(function () {

        $("input[data-bootstrap-switch]").each(function () {
            $(this).bootstrapSwitch('state', $(this).prop('checked'));
        });

    });
</script>
<script type="text/javascript">
    $(document).ready(function () {

        $("#myswitch").bootstrapSwitch();

        $('#myswitch').on('switchChange.bootstrapSwitch', function (e, data) {
            $("#myswitch").prop("checked", data);

        });
    });

</script>
<!-- #endregion -->
<!-- #endregion -->